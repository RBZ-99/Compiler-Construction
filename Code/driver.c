#include "lexer.h"
#include "parser.h"
#include "treeADT.h"
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>

void remove_comments(FILE * inp_fptr, char *no_comment_file)
{
	FILE* outp_fptr = fopen(no_comment_file, "w");
	int state = 0;
	char ch = fgetc(inp_fptr);
	while (ch != EOF) {
		switch (state) {
			case 0:
				if ('*' == ch)
					state = 1;
				else
					fputc(ch, outp_fptr);
				break;
			case 1:
				if ('*' == ch)
					state = 2;
				else
				{
					state = 0;
					fputc('*', outp_fptr);
					fputc(ch, outp_fptr);
				}
				break;
			case 2:
				if ('*' == ch)
					state = 3;
				else 
				{
					if('\n' == ch)
						fputc(ch, outp_fptr);
				} //nothing
				break;
			case 3:
				if ('*' == ch)
					state = 0;
				else
					state = 2;
				break;
			default:
				break;
		}
		ch = fgetc(inp_fptr);
	}	// end of while - file read

	// fclose(inp_fptr);
	fclose(outp_fptr);
	
	printf("Comments removed!! Do you want to check the output : (Y/N)\n");
	char choice;
	scanf("\n%c", &choice);

	if(choice == 'Y')
	{
		FILE *fptr = fopen(no_comment_file, "r");
		char buf[100];


		while(fgets(buf, 99, fptr) != NULL)
		{
			printf("%s", buf);
		}

		printf("\nPress any character to continue\n");
		char ch2;
		scanf("%c", &ch2);
		fclose(fptr);
		
	}
	// fclose(outp_fptr);
}

void print_menu()
{
	printf("\t\t MENU\n");
	printf("-----------------------------------------------------------------\n");
	printf("1. Remove comments from the source code\n");
	printf("2. Print tokens generated by lexer\n");
	printf("3. Print parse tree for the program\n");
	printf("4. Print time taken for tokenizing and parsing\n");
	printf("5. Print first sets\n");
	printf("6. Print follow sets\n");
	printf(" Press any other to exit \n");
	printf("-----------------------------------------------------------------\n");
	printf("Enter your choice:  ");
}
int main(int argc, char *argv[]) 
{

	if( argc < 2 )
	{
		printf("\n\nUsage: make file=<test_case_file_name>\n\n");
		exit(1);
	}

	// setvbuf(stdout, NULL, _IONBF, 0);
 
	int choice;
	char source_file[100];
	strcpy(source_file, argv[1]);

	FILE *source = fopen(source_file, "r");
	if(source == NULL)
	{
		printf("Error opening file\n");
	}

	while(true)
	{
		print_menu();
		scanf("%d", &choice);
		printf("\n");

		switch(choice)
		{
			case 1:
				{
					fseek( source, 0, SEEK_SET );
					char no_comment_file[100];
					printf("Enter name for comment removed source code file\n");
					scanf("%s", no_comment_file);
					remove_comments(source, no_comment_file);
					// print_menu();
				}
				break;
			case 2:
				{
					lexer_init();
					reset_lexer_dfa(source);
					printf("lexer init done\n");
					// getStream(source);
					printf("got the stream\n");
					print_token_stream(source);
					printf("printed token stream\n");
					// reset_lexer_dfa(source);
					
				}
				break;
			case 3:
				{	

					reset_lexer_dfa(source);
					lexer_init();
					parser_init();
					
					// FILE *source = fopen(source_file, "r");
					getStream(source);

					FILE *fptr = fopen("grammar.txt", "r");
					if (fptr == NULL) 
					{
					perror("fopen");
					}
					grammar_fill(fptr);

					populate_first_sets();
						
					populate_follow_sets();
					
					createParseTable();

					tree_node* ptr = parseInputSourceCode(source);

					if(ptr == NULL)
					{
						printf("Empty parse tree\n");
					}

					print_parse_tree(ptr);

					// fclose(source);
					fclose(fptr);
					
				}
				break;
			case 4:
				{
					reset_lexer_dfa(source);
					clock_t    start_time, end_time;

					double total_CPU_time, total_CPU_time_in_seconds;

					start_time = clock();

						// FILE *source = fopen("test.txt", "r");
						lexer_init();
						parser_init();
						getStream(source);
						// print_token_stream(source);

						FILE *fptr = fopen("grammar.txt", "r");
						if (fptr == NULL) 
						{
						perror("fopen");
						}
						grammar_fill(fptr);

						populate_first_sets();
							
						populate_follow_sets();
						
						// reset_lexer_dfa(source);

						// fseek(source, 0, SEEK_SET);

						createParseTable();
						// ull *fset = get_rule_first_set(grammar[0].head);
						// print_parse_table();

						tree_node* ptr = parseInputSourceCode(source);

						// free(source);
						fclose(fptr);

					end_time = clock();

					total_CPU_time  =  (double) (end_time - start_time);

					total_CPU_time_in_seconds =   total_CPU_time / CLOCKS_PER_SEC;

					printf("Total CPU TIME taken : %lf secs\nTotal CPU time in seconds %lf \n", total_CPU_time, total_CPU_time_in_seconds);
					
				}
				break;
			case 5:
				{
					lexer_init();
					parser_init();

					FILE *fptr = fopen("grammar.txt", "r");
					if (fptr == NULL) 
					{
					perror("fopen");
					}
					grammar_fill(fptr);

					populate_first_sets();

					print_first_sets();

					fclose(fptr);
				}
				break;
			case 6:
				{
					lexer_init();
					parser_init();

					FILE *fptr = fopen("grammar.txt", "r");
					if (fptr == NULL) 
					{
					perror("fopen");
					}
					grammar_fill(fptr);

					populate_first_sets();
						
					populate_follow_sets();
					print_follow_sets();

					fclose(fptr);
				}
				break;
			default:
				{
					// break;
					exit(0);
				}
				break;
		}
		fclose(source);
	}
} // end of main
